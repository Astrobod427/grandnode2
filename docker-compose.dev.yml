services:
    grandnode_web:
        build:
            context: .
            dockerfile: Dockerfile.dev # Utilise le nouveau fichier crÃ©Ã©
        container_name: grandnode_dev

        ports:
            # Port d'accÃ¨s pour GrandNode
            - "5011:8080"

        environment:
            ASPNETCORE_ENVIRONMENT: Development
            # Connexion au service MongoDB (nom du container sur dev_services_network)
            ConnectionStrings__Mongodb: mongodb://mongodb_server_dev:27017/grandnode-data
            DOTNET_CLI_TELEMETRY_OPTOUT: "true"
            DOTNET_SKIP_FIRST_TIME_EXPERIENCE: "true"
            # Enable file watching in Docker volumes
            DOTNET_USE_POLLING_FILE_WATCHER: "true"

        volumes:
            # Montage du code source de GrandNode
            - .:/app
            - ~/.nuget/packages:/root/.nuget/packages:ro
            # Isolation des dossiers de build
            - /app/src/Web/Grand.Web/bin
            - /app/src/Web/Grand.Web/obj
            - /root/.dotnet

        # ðŸ’¥ COMMANDE CLÃ‰ : Build la solution complÃ¨te puis watch sur Grand.Web
        command: >
            sh -c "
            echo 'ðŸ§¹ Cleaning static web assets cache to avoid path conflicts...' &&
            find . -path '*/Grand.SharedUIResources/obj/Debug/net9.0/staticwebassets*' -delete 2>/dev/null || true &&
            find . -path '*/Grand.Web.Admin/obj/Debug/net9.0/staticwebassets*' -delete 2>/dev/null || true &&
            find . -path '*/Grand.Web.Vendor/obj/Debug/net9.0/staticwebassets*' -delete 2>/dev/null || true &&
            echo 'ðŸ”§ Building complete solution (including all plugins)...' &&
            dotnet build GrandNode.sln -c Debug &&
            echo 'âœ… Solution built successfully' &&
            echo 'ðŸ‘€ Starting dotnet watch...' &&
            dotnet watch run --project src/Web/Grand.Web/Grand.Web.csproj --urls http://0.0.0.0:8080 --no-launch-profile
            "

        networks:
          - dev_services_network

networks:
  dev_services_network:
    external: true
