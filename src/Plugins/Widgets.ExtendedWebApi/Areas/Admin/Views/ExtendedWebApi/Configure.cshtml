@{
    Layout = "_ConfigurePlugin";
    ViewData["Title"] = "Extended Web API Configuration";
}

<div class="note note-info">
    <h4>Extended Web API Plugin</h4>
    <p>This plugin provides additional REST API endpoints for managing orders, shipments, and merchandise returns.</p>
</div>

<div class="card">
    <div class="card-header">
        <h3 class="card-title">Backend API Endpoints (Admin)</h3>
    </div>
    <div class="card-body">
        <p><strong>Authentication:</strong> JWT Bearer token required</p>
        <p><strong>Base URL:</strong> <code>/api/admin/</code></p>

        <h5>Orders</h5>
        <ul>
            <li><code>GET /api/admin/order</code> - List all orders</li>
            <li><code>GET /api/admin/order/{id}</code> - Get order details</li>
            <li><code>POST /api/admin/order/{id}/MarkAsPaid</code> - Mark order as paid</li>
            <li><code>POST /api/admin/order/{id}/MarkAsAuthorized</code> - Mark payment as authorized</li>
            <li><code>POST /api/admin/order/{id}/Cancel</code> - Cancel order</li>
            <li><code>DELETE /api/admin/order/{id}</code> - Delete order</li>
        </ul>

        <h5>Shipments</h5>
        <ul>
            <li><code>GET /api/admin/shipment</code> - List all shipments</li>
            <li><code>GET /api/admin/shipment/{id}</code> - Get shipment details</li>
            <li><code>POST /api/admin/shipment/{id}/SetAsShipped</code> - Mark as shipped</li>
            <li><code>POST /api/admin/shipment/{id}/SetAsDelivered</code> - Mark as delivered</li>
            <li><code>POST /api/admin/shipment/{id}/SetTrackingNumber</code> - Update tracking number</li>
            <li><code>DELETE /api/admin/shipment/{id}</code> - Delete shipment</li>
        </ul>

        <h5>Merchandise Returns</h5>
        <ul>
            <li><code>GET /api/admin/merchandisereturn</code> - List all returns</li>
            <li><code>GET /api/admin/merchandisereturn/{id}</code> - Get return details</li>
            <li><code>PATCH /api/admin/merchandisereturn/{id}</code> - Update return status/notes</li>
            <li><code>DELETE /api/admin/merchandisereturn/{id}</code> - Delete return</li>
        </ul>

        <h5>Products</h5>
        <ul>
            <li><code>GET /api/admin/product?pageIndex=0&pageSize=50</code> - List all products (paginated)</li>
            <li><code>GET /api/admin/product/{id}</code> - Get product details</li>
            <li><code>GET /api/admin/product/search</code> - <strong>Advanced search with multiple filters</strong> üîç</li>
        </ul>
        <div class="alert alert-info">
            <strong>‚ö° New Advanced Search!</strong> The search endpoint now supports full-text search, category/brand/price filters, and multiple sort options.
            See the <a href="#advanced-search">Advanced Search section below</a> for details and interactive tester.
        </div>

        <h5>Categories</h5>
        <ul>
            <li><code>GET /api/admin/category?pageIndex=0&pageSize=50</code> - List all categories (paginated)</li>
            <li><code>GET /api/admin/category/{id}</code> - Get category details</li>
            <li><code>GET /api/admin/category/tree</code> - Get complete category tree hierarchy</li>
        </ul>

        <h5>Customers</h5>
        <ul>
            <li><code>GET /api/admin/customer?pageIndex=0&pageSize=50</code> - List all customers (paginated)</li>
            <li><code>GET /api/admin/customer/{id}</code> - Get customer details</li>
            <li><code>GET /api/admin/customer/search?email=...</code> - Search customers by email</li>
        </ul>
    </div>
</div>

<div class="card mt-3">
    <div class="card-header">
        <h3 class="card-title">Frontend API Endpoints (Customer)</h3>
    </div>
    <div class="card-body">
        <p><strong>Authentication:</strong> Session-based (customer login)</p>
        <p><strong>Base URL:</strong> <code>/api/my/</code></p>

        <h5>My Orders</h5>
        <ul>
            <li><code>GET /api/my/myorders</code> - List customer's orders</li>
            <li><code>GET /api/my/myorders/{id}</code> - Get order details</li>
        </ul>

        <h5>My Shipments</h5>
        <ul>
            <li><code>GET /api/my/myshipments</code> - List customer's shipments</li>
            <li><code>GET /api/my/myshipments/{id}</code> - Get shipment details</li>
        </ul>

        <h5>My Returns</h5>
        <ul>
            <li><code>GET /api/my/myreturns</code> - List customer's returns</li>
            <li><code>GET /api/my/myreturns/{id}</code> - Get return details</li>
        </ul>
    </div>
</div>

<div class="card mt-3">
    <div class="card-header bg-info text-white">
        <h3 class="card-title">Mobile API Endpoints (Bearer JWT)</h3>
    </div>
    <div class="card-body">
        <p><strong>Authentication:</strong> Bearer JWT token (same as Admin API - <code>/Api/Token/Create</code>)</p>
        <p><strong>Base URL:</strong> <code>/api/mobile/</code></p>
        <div class="alert alert-info">
            <strong>For Mobile Apps:</strong> These endpoints are designed for React Native, Flutter, or other mobile applications.
            They use the same JWT authentication as the admin API but are optimized for customer-facing operations.
        </div>

        <div class="d-flex gap-2 mb-3">
            <a href="/openapi/mobile.json" target="_blank" class="btn btn-outline-primary">
                <i class="fa fa-file-code-o"></i> OpenAPI JSON
            </a>
            <a href="/scalar/mobile" target="_blank" class="btn btn-outline-success">
                <i class="fa fa-book"></i> Interactive Docs (Scalar)
            </a>
            <span class="text-muted align-self-center">
                <small>Available in Development mode only</small>
            </span>
        </div>

        <div class="card bg-light mb-4">
            <div class="card-header">
                <strong>How to Get a JWT Token</strong>
            </div>
            <div class="card-body">
                <p>First, get a JWT token by calling the <code>/Api/Token/Create</code> endpoint with customer credentials:</p>

                <div class="alert alert-danger">
                    <strong>Important:</strong> The password must be <strong>Base64 encoded</strong>!
                </div>

                <pre class="bg-dark text-light p-3"><code># 1. Encode password to Base64
# "MyPassword123" -> "TXlQYXNzd29yZDEyMw=="
echo -n "MyPassword123" | base64
# Output: TXlQYXNzd29yZDEyMw==

# 2. Get JWT token (use Base64 encoded password)
curl -X POST "https://your-domain.com/Api/Token/Create" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "customer@example.com",
    "password": "TXlQYXNzd29yZDEyMw=="
  }'

# Response:
# {
#   "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
#   "expireUtc": "2025-01-15T12:00:00Z"
# }</code></pre>

                <details class="mt-2">
                    <summary><strong>Base64 encoding in different languages</strong></summary>
                    <pre class="bg-secondary text-light p-2 mt-2"><code>// JavaScript
btoa("MyPassword123")  // "TXlQYXNzd29yZDEyMw=="

// Python
import base64
base64.b64encode("MyPassword123".encode()).decode()

// C# / .NET
Convert.ToBase64String(Encoding.UTF8.GetBytes("MyPassword123"))

// Swift
"MyPassword123".data(using: .utf8)?.base64EncodedString()

// Kotlin
Base64.encodeToString("MyPassword123".toByteArray(), Base64.NO_WRAP)</code></pre>
                </details>

                <p class="mt-3">Then use the token in the <code>Authorization</code> header for all Mobile API calls:</p>
                <pre class="bg-dark text-light p-3"><code># Example: Get shopping cart
curl -X GET "https://your-domain.com/api/mobile/ShoppingCart" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."

# Example: Add product to cart
curl -X POST "https://your-domain.com/api/mobile/ShoppingCart" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
  -H "Content-Type: application/json" \
  -d '{
    "productId": "64a1b2c3d4e5f6789",
    "quantity": 2
  }'</code></pre>

                <div class="alert alert-warning mt-3 mb-0">
                    <strong>Note:</strong> Tokens expire after a configurable period (default: 60 minutes).
                    Store the token securely and refresh it before expiration.
                </div>
            </div>
        </div>

        <h5>Shopping Cart</h5>
        <ul>
            <li><code>GET /api/mobile/ShoppingCart</code> - Get current cart with items, prices, and totals</li>
            <li><code>POST /api/mobile/ShoppingCart</code> - Add product to cart <small class="text-muted">(body: {productId, quantity, warehouseId?, attributes?})</small></li>
            <li><code>PUT /api/mobile/ShoppingCart/{itemId}</code> - Update item quantity <small class="text-muted">(body: {quantity})</small></li>
            <li><code>DELETE /api/mobile/ShoppingCart/{itemId}</code> - Remove item from cart</li>
            <li><code>DELETE /api/mobile/ShoppingCart</code> - Clear entire cart</li>
            <li><code>GET /api/mobile/ShoppingCart/count</code> - Get cart item count (quick badge update)</li>
        </ul>

        <h5>Wishlist</h5>
        <ul>
            <li><code>GET /api/mobile/Wishlist</code> - Get wishlist items</li>
            <li><code>POST /api/mobile/Wishlist</code> - Add product to wishlist <small class="text-muted">(body: {productId, quantity?})</small></li>
            <li><code>DELETE /api/mobile/Wishlist/{itemId}</code> - Remove item from wishlist</li>
            <li><code>POST /api/mobile/Wishlist/{itemId}/move-to-cart</code> - Move item from wishlist to cart</li>
            <li><code>DELETE /api/mobile/Wishlist</code> - Clear entire wishlist</li>
            <li><code>GET /api/mobile/Wishlist/count</code> - Get wishlist item count</li>
        </ul>

        <h5>Checkout</h5>
        <ul>
            <li><code>GET /api/mobile/Checkout</code> - Get full checkout summary (cart, totals, addresses, shipping/payment options)</li>
            <li><code>POST /api/mobile/Checkout</code> - Place order <small class="text-muted">(body: {paymentMethodSystemName, shippingOptionName?, useLoyaltyPoints?})</small></li>
            <li><code>GET /api/mobile/Checkout/addresses</code> - Get customer's saved addresses</li>
            <li><code>POST /api/mobile/Checkout/billing-address/{addressId}</code> - Set billing address for checkout</li>
            <li><code>POST /api/mobile/Checkout/shipping-address/{addressId}</code> - Set shipping address for checkout</li>
        </ul>

        <h5>Example: Complete Checkout Flow</h5>
        <pre class="bg-light p-3"><code>// 1. Add products to cart
POST /api/mobile/ShoppingCart
Body: { "productId": "...", "quantity": 2 }

// 2. Get checkout summary (includes available payment/shipping)
GET /api/mobile/Checkout

// 3. Set addresses if needed
POST /api/mobile/Checkout/billing-address/{addressId}
POST /api/mobile/Checkout/shipping-address/{addressId}

// 4. Place order
POST /api/mobile/Checkout
Body: {
  "paymentMethodSystemName": "Payments.CashOnDelivery",
  "shippingOptionName": "Ground",
  "shippingRateProviderSystemName": "Shipping.FixedRate"
}</code></pre>
    </div>
</div>

<div class="card mt-3" id="advanced-search">
    <div class="card-header bg-primary text-white">
        <h3 class="card-title">üîç Advanced Product Search</h3>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h5>Features</h5>
                <ul>
                    <li>‚úÖ <strong>Full-text search</strong> - Name, descriptions, SKU, tags</li>
                    <li>‚úÖ <strong>Category filtering</strong> - Multiple categories</li>
                    <li>‚úÖ <strong>Price range</strong> - Min/max filters</li>
                    <li>‚úÖ <strong>Brand & Vendor</strong> - Filter by IDs</li>
                    <li>‚úÖ <strong>Product flags</strong> - Featured, new, homepage</li>
                    <li>‚úÖ <strong>Sort options</strong> - Position, name, price, date, bestsellers</li>
                    <li>‚úÖ <strong>Pagination</strong> - Efficient result navigation</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h5>Documentation</h5>
                <p>Complete API documentation with 10+ examples:</p>
                <a href="@Url.Action("ApiSearchDocs", "ExtendedWebApi")" target="_blank" class="btn btn-info btn-sm">
                    üìñ View API-SEARCH.md
                </a>
                <hr/>
                <h5>Quick Example</h5>
                <pre class="bg-light p-2"><code>GET /api/admin/product/search
  ?keywords=laptop gaming
  &searchDescriptions=true
  &categoryIds=cat123,cat456
  &priceMin=800
  &priceMax=1500
  &orderBy=2
  &pageSize=20</code></pre>
            </div>
        </div>
    </div>
</div>

<div class="card mt-3">
    <div class="card-header bg-success text-white">
        <h3 class="card-title">üß™ Interactive Search Tester</h3>
    </div>
    <div class="card-body">
        <form id="searchTesterForm">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Keywords</label>
                        <input type="text" class="form-control" id="keywords" placeholder="e.g., laptop gaming">
                        <small class="form-text text-muted">Search text (searches in product name by default)</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Search Scope</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="searchDescriptions">
                            <label class="form-check-label" for="searchDescriptions">
                                Include Descriptions
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="searchSku" checked>
                            <label class="form-check-label" for="searchSku">
                                Include SKU
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="searchProductTags">
                            <label class="form-check-label" for="searchProductTags">
                                Include Product Tags
                            </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Category IDs</label>
                        <input type="text" class="form-control" id="categoryIds" placeholder="cat123,cat456">
                        <small class="form-text text-muted">Comma-separated category IDs</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Brand ID</label>
                        <input type="text" class="form-control" id="brandId" placeholder="brand123">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Vendor ID</label>
                        <input type="text" class="form-control" id="vendorId" placeholder="vendor456">
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Min Price</label>
                            <input type="number" class="form-control" id="priceMin" placeholder="0" step="0.01">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Max Price</label>
                            <input type="number" class="form-control" id="priceMax" placeholder="10000" step="0.01">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Product Flags</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="featuredProducts">
                            <label class="form-check-label" for="featuredProducts">
                                Featured Products Only
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="markedAsNewOnly">
                            <label class="form-check-label" for="markedAsNewOnly">
                                New Products Only
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="showOnHomePage">
                            <label class="form-check-label" for="showOnHomePage">
                                Homepage Products Only
                            </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Sort By</label>
                        <select class="form-control" id="orderBy">
                            <option value="0">Position (Default)</option>
                            <option value="1">Name (A-Z)</option>
                            <option value="2">Price (Low to High)</option>
                            <option value="3">Created Date (Newest)</option>
                            <option value="4">Best Sellers</option>
                            <option value="5">On Sale</option>
                        </select>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Page Size</label>
                            <input type="number" class="form-control" id="pageSize" value="20" min="1" max="100">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Page Index</label>
                            <input type="number" class="form-control" id="pageIndex" value="0" min="0">
                        </div>
                    </div>
                </div>
            </div>

            <hr/>

            <div class="d-flex justify-content-between align-items-center">
                <button type="submit" class="btn btn-primary">
                    üîç Test Search
                </button>
                <button type="button" class="btn btn-info" id="listAllBtn">
                    üìã List All Products (Diagnostic)
                </button>
                <button type="button" class="btn btn-secondary" id="resetForm">
                    üîÑ Reset
                </button>
            </div>
        </form>

        <div id="searchResults" class="mt-4" style="display:none;">
            <hr/>
            <h5>Search Results</h5>
            <div id="generatedUrl" class="alert alert-secondary">
                <strong>Generated URL:</strong><br/>
                <code id="urlDisplay"></code>
                <button type="button" class="btn btn-sm btn-outline-primary float-end" id="copyUrl">
                    üìã Copy
                </button>
            </div>
            <div id="resultsData"></div>
        </div>

        <div id="searchError" class="alert alert-danger mt-4" style="display:none;"></div>
    </div>
</div>

<div class="card mt-3">
    <div class="card-header">
        <h3 class="card-title">Documentation</h3>
    </div>
    <div class="card-body">
        <p>For complete documentation including authentication, request/response examples, and testing instructions, see:</p>
        <ul>
            <li><code>Plugins/Widgets.ExtendedWebApi/README.md</code></li>
            <li><code>Plugins/Widgets.ExtendedWebApi/TESTING.md</code></li>
            <li><strong><a href="@Url.Action("ApiSearchDocs", "ExtendedWebApi")" target="_blank">API-SEARCH.md</a></strong> - Advanced Search API Documentation</li>
        </ul>
    </div>
</div>

<div class="note note-warning mt-3">
    <p><strong>Note:</strong> This plugin does not require any configuration. The endpoints are automatically available once the plugin is installed.</p>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('searchTesterForm');
    const resetBtn = document.getElementById('resetForm');
    const copyBtn = document.getElementById('copyUrl');
    const resultsDiv = document.getElementById('searchResults');
    const errorDiv = document.getElementById('searchError');
    const urlDisplay = document.getElementById('urlDisplay');
    const resultsData = document.
    
    
    
    
    getElementById('resultsData');

    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        // Build query parameters
        const params = new URLSearchParams();

        const keywords = document.getElementById('keywords').value;
        if (keywords) params.append('keywords', keywords);

        if (document.getElementById('searchDescriptions').checked) params.append('searchDescriptions', 'true');
        if (document.getElementById('searchSku').checked) params.append('searchSku', 'true');
        if (document.getElementById('searchProductTags').checked) params.append('searchProductTags', 'true');

        const categoryIds = document.getElementById('categoryIds').value;
        if (categoryIds) params.append('categoryIds', categoryIds);

        const brandId = document.getElementById('brandId').value;
        if (brandId) params.append('brandId', brandId);

        const vendorId = document.getElementById('vendorId').value;
        if (vendorId) params.append('vendorId', vendorId);

        const priceMin = document.getElementById('priceMin').value;
        if (priceMin) params.append('priceMin', priceMin);

        const priceMax = document.getElementById('priceMax').value;
        if (priceMax) params.append('priceMax', priceMax);

        if (document.getElementById('featuredProducts').checked) params.append('featuredProducts', 'true');
        if (document.getElementById('markedAsNewOnly').checked) params.append('markedAsNewOnly', 'true');
        if (document.getElementById('showOnHomePage').checked) params.append('showOnHomePage', 'true');

        params.append('orderBy', document.getElementById('orderBy').value);
        params.append('pageSize', document.getElementById('pageSize').value);
        params.append('pageIndex', document.getElementById('pageIndex').value);

        const url = `@Url.Action("SearchProducts", "ExtendedWebApi")?${params.toString()}`;
        const apiUrl = `/api/admin/product/search?${params.toString()}`;
        urlDisplay.textContent = apiUrl; // Show the API URL for reference

        // Hide previous results/errors
        resultsDiv.style.display = 'none';
        errorDiv.style.display = 'none';

        try {
            const response = await fetch(url, {
                headers: {
                    'Accept': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();

            // Display results
            resultsDiv.style.display = 'block';
            resultsData.innerHTML = `
                <div class="alert alert-success">
                    <strong>‚úÖ Success!</strong> Found ${data.totalCount} products (showing ${data.items.length})
                </div>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>SKU</th>
                                <th>Price</th>
                                <th>Stock</th>
                                <th>Published</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.items.map(p => `
                                <tr>
                                    <td>${p.Name || 'N/A'}</td>
                                    <td>${p.Sku || 'N/A'}</td>
                                    <td>$${p.Price ? p.Price.toFixed(2) : '0.00'}</td>
                                    <td>${p.StockQuantity || 0}</td>
                                    <td>${p.Published ? '‚úÖ' : '‚ùå'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                <p class="text-muted">Page ${data.pageIndex + 1} of ${Math.ceil(data.totalCount / data.pageSize)}</p>
            `;

        } catch (error) {
            errorDiv.textContent = `Error: ${error.message}. Make sure you're authenticated with a valid JWT token.`;
            errorDiv.style.display = 'block';
        }
    });

    // List All Products button
    const listAllBtn = document.getElementById('listAllBtn');
    listAllBtn.addEventListener('click', async function() {
        errorDiv.style.display = 'none';
        resultsDiv.style.display = 'none';

        try {
            const url = `@Url.Action("ListAllProducts", "ExtendedWebApi")?pageSize=100`;
            urlDisplay.textContent = url;

            const response = await fetch(url, {
                headers: { 'Accept': 'application/json' }
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();

            resultsDiv.style.display = 'block';
            resultsData.innerHTML = `
                <div class="alert alert-info">
                    <strong>‚úÖ Diagnostic: Found ${data.totalCount} total products in database</strong>
                    <p class="mb-0">This confirms products exist. If search returns 0, there's an issue with the search logic.</p>
                </div>
                <table class="table table-striped table-sm">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>SKU</th>
                            <th>Price</th>
                            <th>Stock</th>
                            <th>Published</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.items.map(p => `
                            <tr>
                                <td>${p.Name || 'N/A'}</td>
                                <td>${p.Sku || 'N/A'}</td>
                                <td>$${(p.Price || 0).toFixed(2)}</td>
                                <td>${p.StockQuantity || 0}</td>
                                <td>${p.Published ? '‚úÖ' : '‚ùå'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        } catch (error) {
            errorDiv.innerHTML = `<strong>Error:</strong> ${error.message}`;
            errorDiv.style.display = 'block';
        }
    });

    resetBtn.addEventListener('click', function() {
        form.reset();
        document.getElementById('orderBy').value = '0';
        document.getElementById('pageSize').value = '20';
        document.getElementById('pageIndex').value = '0';
        resultsDiv.style.display = 'none';
        errorDiv.style.display = 'none';
    });

    copyBtn.addEventListener('click', function() {
        navigator.clipboard.writeText(urlDisplay.textContent);
        copyBtn.textContent = '‚úÖ Copied!';
        setTimeout(() => {
            copyBtn.textContent = 'üìã Copy';
        }, 2000);
    });
});
</script>
